# 小说阅读页本地缓存设计

## 概述

为小说阅读页添加本地缓存功能，避免每次刷新都重新请求 API。使用 Zustand persist 中间件实现，保留最近 20 本小说的详情、内容和阅读进度。同时新增点击标题查看详情弹窗功能。

## 需求

### 当前问题
- 搜索页使用本地缓存，不会重复请求 API
- 小说阅读页每次刷新都会重新请求 API
- 用户体验不一致，浪费网络资源

### 目标
1. 阅读页使用本地缓存，避免重复请求
2. 保留最近 20 本小说的缓存
3. 缓存小说详情、内容和阅读进度
4. 提供手动刷新功能
5. 新增点击标题查看详情弹窗

## 架构设计

### 缓存方案
使用 Zustand persist 中间件（方案 A），与搜索页保持一致。

### 存储介质
localStorage

### 缓存策略
LRU（最近最少使用），保留最近 20 本小说

### 数据结构
```typescript
{
  novelCache: {
    [novelId: string]: {
      novel: NovelDetail,
      pages: NovelPage[],
      currentPage: number,
      timestamp: number  // 最后访问时间
    }
  },
  cacheOrder: string[]  // novelId 数组，按访问时间排序
}
```

## 核心功能

### 缓存管理
- 读取小说时先检查缓存，命中则直接使用
- 未命中或用户手动刷新时请求 API
- 每次访问更新 timestamp 和 cacheOrder
- 超过 20 本时删除最旧的缓存

### 阅读进度保存
- 用户切换页码时自动保存到缓存
- 重新打开小说时恢复到上次阅读位置

### 手动刷新
- 在阅读页添加刷新按钮
- 点击后强制重新请求 API 并更新缓存

### 详情弹窗（新功能）
- 点击顶栏标题弹出 Modal 显示小说详情
- 显示封面、标题、作者、简介、标签、统计数据等
- 点击遮罩或关闭按钮关闭弹窗

## 数据流

### 首次加载流程
1. 用户打开小说阅读页（`/reader/:novelId`）
2. `readerStore.loadNovel()` 检查缓存
3. 缓存未命中 → 请求 API → 保存到缓存 → 渲染
4. 缓存命中 → 直接渲染 → 恢复阅读进度

### 手动刷新流程
1. 用户点击刷新按钮
2. `readerStore.refreshNovel()` 强制请求 API
3. 更新缓存中的数据
4. 重新渲染（保持当前页码）

### 缓存淘汰流程
1. 新小说加入缓存时检查数量
2. 超过 20 本 → 找到 `cacheOrder` 最后一个（最旧）
3. 删除该小说的缓存数据
4. 更新 `cacheOrder`

## UI 变更

### 阅读页顶栏
- 标题区域添加点击事件
- 点击后弹出小说详情 Modal
- 添加刷新按钮（图标：↻）

### 详情弹窗组件
- 半透明遮罩背景
- 居中卡片显示详情内容
- 包含：封面图、标题、作者、简介、标签、收藏数、浏览数等
- 点击遮罩或关闭按钮关闭

### 加载状态
- 从缓存加载时不显示 loading（即时显示）
- API 请求时显示 loading 指示器
- 刷新时显示轻量提示（toast）

## 错误处理与边界情况

### 缓存损坏
- localStorage 数据格式错误时清空缓存
- 使用 try-catch 包裹缓存读取逻辑
- 降级到 API 请求

### 存储空间不足
- localStorage 写入失败时捕获异常
- 尝试清理最旧的缓存后重试
- 仍失败则仅使用内存缓存（不持久化）

### 网络错误
- 缓存命中时即使离线也能阅读
- 缓存未命中且网络错误时显示友好提示
- 提供重试按钮

### 数据一致性
- 缓存的 novelId 作为唯一标识
- timestamp 用于排序和淘汰
- 页码范围校验（1 到 totalPages）

## 实现清单

### 1. 修改 readerStore.ts
- [ ] 添加 persist 中间件
- [ ] 添加 novelCache 和 cacheOrder 状态
- [ ] 实现 LRU 缓存管理逻辑
- [ ] 修改 loadNovel 支持缓存读取
- [ ] 添加 refreshNovel 方法（强制刷新）
- [ ] 修改 setPage 自动保存进度

### 2. 创建详情弹窗组件
- [ ] 创建 NovelDetailModal.tsx
- [ ] 实现弹窗 UI（遮罩、卡片、关闭按钮）
- [ ] 显示小说详情信息
- [ ] 添加打开/关闭状态管理

### 3. 修改阅读页组件
- [ ] 标题区域添加点击事件
- [ ] 集成详情弹窗组件
- [ ] 添加刷新按钮
- [ ] 优化加载状态显示

### 4. 测试
- [ ] 测试缓存读写
- [ ] 测试 LRU 淘汰逻辑
- [ ] 测试阅读进度保存
- [ ] 测试手动刷新
- [ ] 测试详情弹窗
- [ ] 测试错误处理
